{% extends "business/base.html" %}

{% block title %}Ситуационный центр | Система бронирования{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/situation_center.css') }}">
<style>
/* Адаптивный дизайн для мобильной версии */
@media (max-width: 991px) {
    #situation-center {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow-y: auto;
    }
    
    #panel-right {
        order: 1;
        width: 100%;
        height: auto;
        border-radius: 12px;
        margin-bottom: 10px;
    }
    
    #panel-main {
        order: 2;
        width: 100%;
        height: auto;
        min-height: 60vh;
    }
    
    #panel-bottom {
        order: 3;
        width: 100%;
        height: auto;
    }
    
    .panel-content {
        position: relative;
        height: auto;
        max-height: none;
    }
    
    body {
        overflow: auto;
    }
    
    /* Мобильная навигация */
    .mobile-nav-bar {
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg-panel);
        box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        padding: 10px;
        z-index: 1000;
    }
    
    .mobile-nav-btn {
        flex: 1;
        text-align: center;
        padding: 8px;
        color: var(--text-light);
        font-size: 0.75rem;
    }
    
    .mobile-nav-btn i {
        display: block;
        font-size: 1.2rem;
        margin-bottom: 4px;
    }
    
    .mobile-nav-btn.active {
        color: var(--primary);
    }
    
    .stats-card {
        margin-bottom: 15px;
    }
}

@media (max-width: 576px) {
    .situation-center-layout {
        padding: 5px;
    }
    
    .panel-content {
        padding: 10px;
    }
    
    .nav-item span {
        font-size: 0.85rem;
    }
    
    .panel-header h4 {
        font-size: 1.1rem;
    }
    
    .dashboard-container .row [class*="col-"] {
        padding-right: 5px;
        padding-left: 5px;
    }
    
    .table {
        font-size: 0.8rem;
    }
}
</style>
{% endblock %}

{% block content %}
<style>
    /* Запрещаем прокрутку документа */
    body {
        overflow: hidden;
    }

    /* Стили для модальных окон входа и регистрации */
    .auth-modal .modal-header {
        border-bottom: none;
        padding-bottom: 0;
    }
    
    .auth-modal .nav-tabs {
        border-bottom: none;
        margin-bottom: 20px;
    }
    
    .auth-modal .nav-link {
        border: none;
        border-bottom: 2px solid transparent;
        border-radius: 0;
        padding: 10px 15px;
        color: var(--text-light);
    }
    
    .auth-modal .nav-link.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
        background-color: transparent;
    }
    
    .auth-modal .form-control {
        border-radius: 4px;
        padding: 12px;
        height: auto;
    }
    
    .auth-modal .btn-neon {
        padding: 12px;
        border-radius: 4px;
    }
    
    .auth-modal .modal-footer {
        border-top: none;
        padding-top: 0;
    }
    
    .auth-status {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
        display: none;
    }
    
    .auth-status.success {
        background-color: var(--success);
        color: var(--text-light);
    }
    
    .auth-status.error {
        background-color: var(--danger);
        color: var(--text-light);
    }
    
    .count-badge {
        background-color: var(--danger);
        color: white;
        font-size: 0.75rem;
        padding: 0.25em 0.5em;
        border-radius: 50rem;
    }
</style>



<!-- Контейнер для ситуационного центра -->
<div id="situation-center" class="situation-center-layout">
    <!-- Правая панель (навигация и управление) -->
    <div id="panel-right" class="panel-right visionos-card">
        <div class="panel-header">
            <h4 class="gradient-text">Управление</h4>
            <div class="panel-controls">
                <button class="refresh-data" title="Обновить данные">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>
        <div id="right-panel-content" class="panel-content">
            
            
            <!-- Навигационное меню -->
            <div class="navigation-menu">
                <div class="nav-section">
                    <div class="nav-section-title">Основное</div>
                    <div class="nav-item active" data-section="dashboard" data-title="Обзор">
                        <i class="bi bi-house-door"></i>
                        <span>Обзор</span>
                    </div>
                    <div class="nav-item" onclick="window.location.href='https://qwerty.love-this.ru/'" data-title="Компании">
                        <i class="bi bi-building"></i>
                        <span>Компании</span>
                    </div>
                    <div class="nav-item" data-section="services" data-title="Услуги">
                        <i class="bi bi-briefcase"></i>
                        <span>Услуги</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Бронирования</div>
                    <div class="nav-item" data-section="bookings" data-title="Все бронирования">
                        <i class="bi bi-calendar-check"></i>
                        <span>Все бронирования</span>
                    </div>
                    <div class="nav-item" data-section="new-bookings" data-title="Новые бронирования">
                        <i class="bi bi-calendar-plus"></i>
                        <span>Новые</span>
                        <span class="count-badge" id="new-bookings-count">2</span>
                    </div>
                    <div class="nav-item" data-section="schedule" data-title="Расписание">
                        <i class="bi bi-clock"></i>
                        <span>Расписание</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Аналитика</div>
                    <div class="nav-item" data-section="analytics" data-title="Аналитика">
                        <i class="bi bi-graph-up"></i>
                        <span>Аналитика</span>
                    </div>
                    <div class="nav-item" data-section="reports" data-title="Отчеты">
                        <i class="bi bi-file-text"></i>
                        <span>Отчеты</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Администрирование</div>
                    <div class="nav-item" data-section="moderation" data-title="Модерация">
                        <i class="bi bi-check-square"></i>
                        <span>Модерация</span>
                        <span class="count-badge" id="moderation-count">0</span>
                    </div>
                    <div class="nav-item" data-section="telegram" data-title="Настройки Telegram">
                        <i class="bi bi-telegram"></i>
                        <span>Telegram</span>
                    </div>
                    <div class="nav-item" data-section="profile" data-title="Профиль">
                        <i class="bi bi-person-gear"></i>
                        <span>Профиль</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Основная панель (контент) -->
    <div id="panel-main" class="panel-main visionos-card">
        <div class="panel-header">
            <h4 id="main-panel-title" class="gradient-text">Обзор</h4>
            <div class="panel-controls">
                <span class="current-section-indicator" id="current-section-indicator">Обзор</span>
            </div>
        </div>
        <div id="main-panel-content" class="panel-content">
            <!-- Содержимое будет загружено динамически -->
            <div id="loading-placeholder" class="loading-placeholder">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p>Загрузка данных...</p>
            </div>
        </div>
    </div>
    
    <!-- Нижняя панель (контекстная информация) -->
    <div id="panel-bottom" class="panel-bottom visionos-card">
        <div class="panel-header">
            <h4 id="bottom-panel-title" class="gradient-text">Статистика и аналитика</h4>
            <div class="panel-controls">
                <button class="refresh-bottom-panel" title="Обновить статистику">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        <div id="bottom-panel-content" class="panel-content">
            <!-- Статистика будет добавлена динамически -->
            <div class="bottom-panel-container">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">Динамика бронирований</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 150px;">
                                    <canvas id="bookings-trend-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">Распределение услуг</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 150px;">
                                    <canvas id="services-distribution-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно авторизации и регистрации -->
<div class="modal fade auth-modal" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <ul class="nav nav-tabs w-100" id="authTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login-tab-pane" type="button" role="tab" aria-controls="login-tab-pane" aria-selected="true">Вход</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register-tab-pane" type="button" role="tab" aria-controls="register-tab-pane" aria-selected="false">Регистрация</button>
                    </li>
                </ul>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <div class="tab-content" id="authTabsContent">
                    <!-- Таб входа -->
                    <div class="tab-pane fade show active" id="login-tab-pane" role="tabpanel" aria-labelledby="login-tab" tabindex="0">
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="login-email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="login-email" required>
                            </div>
                            <div class="mb-3">
                                <label for="login-password" class="form-label">Пароль</label>
                                <input type="password" class="form-control" id="login-password" required>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">Войти</button>
                            </div>
                            <div class="auth-status" id="login-status"></div>
                        </form>
                    </div>
                    
                    <!-- Таб регистрации -->
                    <div class="tab-pane fade" id="register-tab-pane" role="tabpanel" aria-labelledby="register-tab" tabindex="0">
                        <form id="registerForm">
                            <div class="mb-3">
                                <label for="register-email" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="register-email" required>
                            </div>
                            <div class="mb-3">
                                <label for="register-password" class="form-label">Пароль *</label>
                                <input type="password" class="form-control" id="register-password" minlength="8" required>
                                <div class="form-text">Минимум 8 символов</div>
                            </div>
                            <div class="mb-3">
                                <label for="register-password-confirm" class="form-label">Подтверждение пароля *</label>
                                <input type="password" class="form-control" id="register-password-confirm" minlength="8" required>
                            </div>
                            <div class="mb-3">
                                <label for="register-first-name" class="form-label">Имя</label>
                                <input type="text" class="form-control" id="register-first-name">
                            </div>
                            <div class="mb-3">
                                <label for="register-last-name" class="form-label">Фамилия</label>
                                <input type="text" class="form-control" id="register-last-name">
                            </div>
                            <div class="mb-3">
                                <label for="register-phone" class="form-label">Телефон</label>
                                <input type="text" class="form-control" id="register-phone">
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">Зарегистрироваться</button>
                            </div>
                            <div class="auth-status" id="register-status"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Мобильная навигация - видна только на маленьких экранах -->
<div class="mobile-nav-bar d-md-none">
    <div class="mobile-nav-btn active" data-section="dashboard">
        <i class="bi bi-house-door"></i>
        <span>Обзор</span>
    </div>
    <div class="mobile-nav-btn" data-section="services">
        <i class="bi bi-briefcase"></i>
        <span>Услуги</span>
    </div>
    <div class="mobile-nav-btn" data-section="bookings">
        <i class="bi bi-calendar-check"></i>
        <span>Бронирования</span>
    </div>
    <div class="mobile-nav-btn" data-section="analytics">
        <i class="bi bi-graph-up"></i>
        <span>Аналитика</span>
    </div>
    <div class="mobile-nav-btn" data-section="profile">
        <i class="bi bi-person-gear"></i>
        <span>Профиль</span>
    </div>
</div>

<!-- Данные компаний (если есть) -->
{% if companies %}
<script id="company-data-json" type="application/json">
    {{ companies|tojson }}
</script>
{% endif %}

<!-- Шаблоны для различных разделов -->
<!-- Шаблон панели управления -->
<script type="text/template" id="dashboard-template">
    <div class="dashboard-container">
        <!-- Аналитические карточки -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-card-icon bg-primary">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="stats-card-content">
                        <div class="stats-card-value" id="total-companies">0</div>
                        <div class="stats-card-title">Компаний</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-card-icon bg-success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stats-card-content">
                        <div class="stats-card-value" id="active-companies">0</div>
                        <div class="stats-card-title">Активных</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-card-icon bg-warning">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                    <div class="stats-card-content">
                        <div class="stats-card-value" id="pending-companies">0</div>
                        <div class="stats-card-title">На модерации</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-card-icon bg-info">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stats-card-content">
                        <div class="stats-card-value" id="total-clients">0</div>
                        <div class="stats-card-title">Клиентов</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Вторая строка статистики -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-card-icon bg-danger">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stats-card-content">
                        <div class="stats-card-value" id="total-bookings">0</div>
                        <div class="stats-card-title">Бронирований</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-card-icon bg-secondary">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <div class="stats-card-content">
                        <div class="stats-card-value" id="total-services">0</div>
                        <div class="stats-card-title">Услуг</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-card-icon bg-primary">
                        <i class="fas fa-ruble-sign"></i>
                    </div>
                    <div class="stats-card-content">
                        <div class="stats-card-value" id="total-revenue">0 ₽</div>
                        <div class="stats-card-title">Выручка</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-card-icon bg-success">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stats-card-content">
                        <div class="stats-card-value" id="growth-rate">+0%</div>
                        <div class="stats-card-title">Рост</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Графики -->
        <div class="row mb-4">
            <div class="col-md-8 mb-3">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Активность бронирований</h5>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="activity-chart-period" data-bs-toggle="dropdown" aria-expanded="false">
                                За неделю
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="activity-chart-period">
                                <li><a class="dropdown-item" href="#" data-period="week">За неделю</a></li>
                                <li><a class="dropdown-item" href="#" data-period="month">За месяц</a></li>
                                <li><a class="dropdown-item" href="#" data-period="quarter">За квартал</a></li>
                                <li><a class="dropdown-item" href="#" data-period="year">За год</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="activity-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">Распределение услуг</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="services-pie-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Последние данные и быстрые действия -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">Последние бронирования</h5>
                    </div>
                    <div class="card-body" id="recent-bookings">
                        <div class="loading-placeholder">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                            <p>Загрузка бронирований...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Быстрые действия</h5>
                    </div>
                    <div class="card-body">
                        <div class="action-buttons">
                            <button class="btn btn-primary mb-2 me-2 create-company-btn">
                                <i class="fas fa-plus-circle me-2"></i>Создать компанию
                            </button>
                            <button class="btn btn-success mb-2 me-2" id="add-service-btn">
                                <i class="fas fa-plus-circle me-2"></i>Добавить услугу
                            </button>
                            <button class="btn btn-info mb-2 me-2">
                                <i class="fas fa-cog me-2"></i>Настройки
                            </button>
                            <button class="btn btn-warning mb-2">
                                <i class="fas fa-file-export me-2"></i>Экспорт
                            </button>
                        </div>
                        
                        <!-- Форма быстрого добавления услуги -->
                        <div class="quick-add-service-form mt-4" style="display: none;">
                            <h6 class="gradient-text">Быстрое добавление услуги</h6>
                            <form id="quickAddServiceForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="serviceCompany" class="form-label">Компания</label>
                                        <select class="form-select" id="serviceCompany" required>
                                            <option value="" selected disabled>Выберите компанию</option>
                                            <!-- Компании будут добавлены динамически -->
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="serviceName" class="form-label">Название услуги</label>
                                        <input type="text" class="form-control" id="serviceName" required>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="serviceCategory" class="form-label">Категория</label>
                                        <select class="form-select" id="serviceCategory" required>
                                            <option value="" selected disabled>Выберите категорию</option>
                                            <option value="1">Красота</option>
                                            <option value="2">Здоровье</option>
                                            <option value="3">Спорт</option>
                                            <option value="4">Авто</option>
                                            <option value="5">Обучение</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="servicePrice" class="form-label">Цена (₽)</label>
                                        <input type="number" class="form-control" id="servicePrice" required min="0">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="serviceDuration" class="form-label">Длительность (мин)</label>
                                        <input type="number" class="form-control" id="serviceDuration" required min="0">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="serviceStatus" class="form-label">Статус</label>
                                        <select class="form-select" id="serviceStatus">
                                            <option value="active" selected>Активна</option>
                                            <option value="inactive">Неактивна</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="serviceDescription" class="form-label">Описание</label>
                                    <textarea class="form-control" id="serviceDescription" rows="2"></textarea>
                                </div>
                                <div class="d-flex justify-content-end">
                                    <button type="button" class="btn btn-secondary me-2" id="cancel-service-btn">Отмена</button>
                                    <button type="submit" class="btn btn-primary">Сохранить услугу</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<!-- Шаблон списка компаний -->
<script type="text/template" id="companies-template">
    <div class="companies-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <div class="filter-controls me-3">
                    <select class="form-select form-select-sm" id="companies-filter">
                        <option value="all">Все компании</option>
                        <option value="approved">Активные</option>
                        <option value="pending">На модерации</option>
                        <option value="rejected">Отклоненные</option>
                    </select>
                </div>
                <div class="search-controls">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" placeholder="Поиск компаний..." id="companies-search">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div>
                <button class="btn btn-primary create-company-btn">
                    <i class="fas fa-plus"></i> Создать компанию
                </button>
            </div>
        </div>
        
        <div id="companies-list" class="companies-grid">
            <div class="loading-placeholder">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p>Загрузка списка компаний...</p>
            </div>
        </div>
    </div>
</script>

<!-- Шаблон формы компании -->
<script type="text/template" id="company-form-template">
    <div class="company-form-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 id="company-form-title">Создание компании</h4>
            <button class="btn btn-outline-secondary back-to-companies">
                <i class="fas fa-arrow-left"></i> Назад к списку
            </button>
        </div>
        
        <form id="company-form" class="needs-validation">
            <input type="hidden" id="company-id">
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Основная информация</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="company-name" class="form-label">Название компании*</label>
                        <input type="text" class="form-control" id="company-name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="company-description" class="form-label">Описание компании*</label>
                        <textarea class="form-control" id="company-description" rows="3" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="company-category" class="form-label">Категория*</label>
                        <select class="form-select" id="company-category" required>
                            <option value="" disabled selected>Выберите категорию</option>
                            <option value="1">Рестораны</option>
                            <option value="2">Салоны красоты</option>
                            <option value="3">Медицинские услуги</option>
                            <option value="4">Спортивные центры</option>
                            <option value="5">Автосервисы</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Контактная информация</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="company-phone" class="form-label">Телефон*</label>
                            <input type="tel" class="form-control" id="company-phone" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="company-email" class="form-label">Email*</label>
                            <input type="email" class="form-control" id="company-email" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="company-website" class="form-label">Веб-сайт</label>
                        <input type="url" class="form-control" id="company-website">
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Адрес</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="company-address" class="form-label">Адрес*</label>
                        <input type="text" class="form-control" id="company-address" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="company-city" class="form-label">Город*</label>
                            <input type="text" class="form-control" id="company-city" required>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="company-region" class="form-label">Регион</label>
                            <input type="text" class="form-control" id="company-region">
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="company-postal-code" class="form-label">Почтовый индекс</label>
                            <input type="text" class="form-control" id="company-postal-code">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-end mt-4">
                <button type="button" class="btn btn-secondary me-2 back-to-companies">Отмена</button>
                <button type="submit" class="btn btn-primary" id="save-company-btn">Создать компанию</button>
            </div>
        </form>
    </div>
</script>

<!-- Шаблон деталей компании -->
<script type="text/template" id="company-details-template">
    <div class="company-details-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 id="company-name-display">Название компании</h4>
                <div id="company-status-badge"></div>
            </div>
            <button class="btn btn-outline-secondary back-to-companies">
                <i class="fas fa-arrow-left"></i> Назад к списку
            </button>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Информация о компании</h5>
            </div>
            <div class="card-body">
                <p id="company-description-display" class="mb-4"></p>
                
                <h6>Контактная информация:</h6>
                <div class="company-meta mb-4">
                    <div class="meta-row">
                        <div class="meta-label">Телефон:</div>
                        <div class="meta-value" id="company-phone-display"></div>
                    </div>
                    <div class="meta-row">
                        <div class="meta-label">Email:</div>
                        <div class="meta-value" id="company-email-display"></div>
                    </div>
                    <div class="meta-row" id="company-website-row">
                        <div class="meta-label">Веб-сайт:</div>
                        <div class="meta-value" id="company-website-display"></div>
                    </div>
                    <div class="meta-row" id="company-address-row">
                        <div class="meta-label">Адрес:</div>
                        <div class="meta-value" id="company-address-display"></div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-end">
                    <button class="btn btn-outline-primary edit-company-btn" data-id="">
                        <i class="fas fa-edit"></i> Редактировать
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Услуги компании</h5>
                <button class="btn btn-sm btn-outline-primary add-service-btn">
                    <i class="fas fa-plus"></i> Добавить услугу
                </button>
            </div>
            <div class="card-body">
                <div id="company-services">
                    <div class="loading-placeholder">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p>Загрузка списка услуг...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<!-- Шаблон для нижней панели: Статистика и аналитика (расширенный) -->
<script type="text/template" id="bottom-panel-stats-template">
    <div class="bottom-panel-container">
        <div class="row">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">Динамика бронирований</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 150px;">
                            <canvas id="bookings-trend-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">Распределение услуг</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 150px;">
                            <canvas id="services-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">Популярные услуги</h5>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush top-services">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Стрижка мужская</span>
                                <span class="badge bg-primary rounded-pill">214</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Маникюр</span>
                                <span class="badge bg-primary rounded-pill">158</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Массаж спины</span>
                                <span class="badge bg-primary rounded-pill">96</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Шиномонтаж</span>
                                <span class="badge bg-primary rounded-pill">85</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<!-- Шаблон для нижней панели при просмотре компании -->
<script type="text/template" id="bottom-panel-company-template">
    <div class="bottom-panel-container">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Аналитика компании</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-5">
                        <div class="chart-container" style="height: 150px;">
                            <canvas id="company-services-chart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="stats-list">
                            <div class="stats-item">
                                <div class="stats-title">Всего бронирований:</div>
                                <div class="stats-value" id="company-total-bookings">0</div>
                            </div>
                            <div class="stats-item">
                                <div class="stats-title">Среднее время бронирования:</div>
                                <div class="stats-value" id="company-avg-booking-time">0 мин</div>
                            </div>
                            <div class="stats-item">
                                <div class="stats-title">Загруженность:</div>
                                <div class="stats-value" id="company-occupancy-rate">0%</div>
                            </div>
                            <div class="stats-item">
                                <div class="stats-title">Активных услуг:</div>
                                <div class="stats-value" id="company-active-services">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<!-- Шаблон для нижней панели: Календарь ближайших бронирований -->
<script type="text/template" id="bottom-panel-calendar-template">
    <div class="bottom-panel-container">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Ближайшие бронирования</h5>
            </div>
            <div class="card-body p-0">
                <div class="calendar-view" id="mini-calendar">
                    <div class="calendar-loading text-center p-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка календаря...</span>
                        </div>
                        <p class="mt-2">Загрузка календаря...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<!-- Шаблон управления услугами -->
<script type="text/template" id="services-template">
    <div class="services-container">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
            <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center mb-3 mb-md-0 w-100 w-md-auto">
                <div class="filter-controls me-0 me-md-3 mb-2 mb-md-0 w-100 w-md-auto">
                    <select class="form-select form-select-sm" id="services-filter">
                        <option value="all">Все услуги</option>
                        <option value="active">Активные</option>
                        <option value="inactive">Неактивные</option>
                    </select>
                </div>
                <div class="search-controls w-100 w-md-auto">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" placeholder="Поиск услуг..." id="services-search">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="mt-3 mt-md-0">
                <button class="btn btn-primary w-100 w-md-auto" id="service-add-btn">
                    <i class="fas fa-plus"></i> Добавить услугу
                </button>
            </div>
        </div>
        
        <!-- Таблица услуг для десктопа -->
        <div class="card mb-4 d-none d-md-block">
            <div class="card-header">
                <h5 class="mb-0">Список услуг</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle services-table" id="services-table">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 50px">#</th>
                                <th scope="col">Название</th>
                                <th scope="col">Компания</th>
                                <th scope="col">Категория</th>
                                <th scope="col">Цена</th>
                                <th scope="col">Длительность</th>
                                <th scope="col">Статус</th>
                                <th scope="col" style="width: 120px">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="services-list">
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="loading-placeholder">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Загрузка...</span>
                                        </div>
                                        <p>Загрузка списка услуг...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <nav aria-label="Страницы услуг">
                    <ul class="pagination pagination-sm justify-content-center mb-0">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Предыдущая</a>
                        </li>
                        <li class="page-item active" aria-current="page">
                            <a class="page-link" href="#">1</a>
                        </li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#">Следующая</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        
        <!-- Карточки услуг для мобильной версии -->
        <div class="d-md-none" id="services-cards">
            <div class="loading-placeholder text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p>Загрузка списка услуг...</p>
            </div>
        </div>
    </div>
</script>

<!-- Шаблон карточки услуги для мобильной версии (будет использоваться в JavaScript) -->
<script type="text/template" id="service-card-template">
    <div class="card mb-3 service-card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0">${name}</h5>
                <span class="badge ${status === 'active' ? 'bg-success' : 'bg-secondary'}">${status === 'active' ? 'Активна' : 'Неактивна'}</span>
            </div>
            <p class="card-text text-muted mb-1">${company}</p>
            <p class="card-text mb-1"><small>Категория: ${category}</small></p>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <span class="badge bg-primary me-2">${price} ₽</span>
                    <span class="badge bg-info">${duration} мин</span>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-1 edit-service-btn" data-id="${id}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-service-btn" data-id="${id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</script>

<!-- Шаблон модального окна добавления/редактирования услуги -->
<script type="text/template" id="service-modal-template">
    <div class="modal fade" id="serviceModal" tabindex="-1" aria-labelledby="serviceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="serviceModalLabel">Добавление услуги</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="serviceForm" class="needs-validation">
                        <input type="hidden" id="service-id" value="">
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="service-company" class="form-label">Компания*</label>
                                <select class="form-select" id="service-company" required>
                                    <option value="" selected disabled>Выберите компанию</option>
                                </select>
                                <div class="invalid-feedback">Пожалуйста, выберите компанию</div>
                            </div>
                            <div class="col-md-6">
                                <label for="service-category" class="form-label">Категория*</label>
                                <select class="form-select" id="service-category" required>
                                    <option value="" selected disabled>Выберите категорию</option>
                                    <option value="1">Красота</option>
                                    <option value="2">Здоровье</option>
                                    <option value="3">Спорт</option>
                                    <option value="4">Авто</option>
                                    <option value="5">Обучение</option>
                                </select>
                                <div class="invalid-feedback">Пожалуйста, выберите категорию</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="service-name" class="form-label">Название услуги*</label>
                            <input type="text" class="form-control" id="service-name" required>
                            <div class="invalid-feedback">Пожалуйста, введите название услуги</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="service-description" class="form-label">Описание</label>
                            <textarea class="form-control" id="service-description" rows="3"></textarea>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="service-price" class="form-label">Цена (₽)*</label>
                                <input type="number" class="form-control" id="service-price" min="0" step="0.01" required>
                                <div class="invalid-feedback">Пожалуйста, укажите цену</div>
                            </div>
                            <div class="col-md-4">
                                <label for="service-duration" class="form-label">Длительность (мин)*</label>
                                <input type="number" class="form-control" id="service-duration" min="5" step="5" required>
                                <div class="invalid-feedback">Пожалуйста, укажите длительность</div>
                            </div>
                            <div class="col-md-4">
                                <label for="service-max-persons" class="form-label">Макс. клиентов</label>
                                <input type="number" class="form-control" id="service-max-persons" min="1" value="1">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Дни недели</label>
                                <div class="d-flex flex-wrap">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="checkbox" value="1" id="service-day-1" checked>
                                        <label class="form-check-label" for="service-day-1">Пн</label>
                                    </div>
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="checkbox" value="2" id="service-day-2" checked>
                                        <label class="form-check-label" for="service-day-2">Вт</label>
                                    </div>
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="checkbox" value="3" id="service-day-3" checked>
                                        <label class="form-check-label" for="service-day-3">Ср</label>
                                    </div>
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="checkbox" value="4" id="service-day-4" checked>
                                        <label class="form-check-label" for="service-day-4">Чт</label>
                                    </div>
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="checkbox" value="5" id="service-day-5" checked>
                                        <label class="form-check-label" for="service-day-5">Пт</label>
                                    </div>
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="checkbox" value="6" id="service-day-6" checked>
                                        <label class="form-check-label" for="service-day-6">Сб</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="7" id="service-day-7" checked>
                                        <label class="form-check-label" for="service-day-7">Вс</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Время работы</label>
                                <div class="row">
                                    <div class="col-6">
                                        <label for="service-time-start" class="form-label small">Начало</label>
                                        <input type="time" class="form-control" id="service-time-start" value="09:00">
                                    </div>
                                    <div class="col-6">
                                        <label for="service-time-end" class="form-label small">Окончание</label>
                                        <input type="time" class="form-control" id="service-time-end" value="18:00">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="service-image" class="form-label">Изображение</label>
                                <input type="file" class="form-control" id="service-image" accept="image/*">
                            </div>
                            <div class="col-md-6">
                                <label for="service-status" class="form-label">Статус</label>
                                <select class="form-select" id="service-status">
                                    <option value="active" selected>Активна</option>
                                    <option value="inactive">Неактивна</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Дополнительные настройки</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="1" id="service-online-booking" checked>
                                <label class="form-check-label" for="service-online-booking">
                                    Разрешить онлайн-бронирование
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="1" id="service-prepayment">
                                <label class="form-check-label" for="service-prepayment">
                                    Требуется предоплата
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="1" id="service-featured">
                                <label class="form-check-label" for="service-featured">
                                    Рекомендуемая услуга
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="save-service-btn">Сохранить</button>
                </div>
            </div>
        </div>
    </div>
</script>

<!-- Шаблон модального окна подтверждения удаления услуги -->
<script type="text/template" id="service-delete-modal-template">
    <div class="modal fade" id="deleteServiceModal" tabindex="-1" aria-labelledby="deleteServiceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteServiceModalLabel">Подтверждение удаления</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Вы действительно хотите удалить услугу <strong id="delete-service-name"></strong>?</p>
                    <p class="text-danger">Это действие невозможно отменить.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-service">Удалить</button>
                </div>
            </div>
        </div>
    </div>
</script>

<!-- Дополнительный JavaScript для управления услугами -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Загружаем начальные данные сервисов
        function loadServices() {
            // В реальности здесь мы бы загружали данные с сервера
            const services = [
                { id: 1, name: 'Стрижка мужская', company: 'Салон красоты "Эстетика"', company_id: 1, category: 'Красота', category_id: 1, price: 500, duration: 30, status: 'active' },
                { id: 2, name: 'Маникюр классический', company: 'Салон красоты "Эстетика"', company_id: 1, category: 'Красота', category_id: 1, price: 800, duration: 60, status: 'active' },
                { id: 3, name: 'Замена масла', company: 'Автосервис "Мастер"', company_id: 2, category: 'Авто', category_id: 4, price: 1500, duration: 45, status: 'active' },
                { id: 4, name: 'Массаж спины', company: 'Медицинский центр "Здоровье"', company_id: 4, category: 'Здоровье', category_id: 2, price: 1200, duration: 60, status: 'active' },
                { id: 5, name: 'Персональная тренировка', company: 'Спортзал "Атлетик"', company_id: 3, category: 'Спорт', category_id: 3, price: 1000, duration: 90, status: 'inactive' }
            ];
            
            displayServices(services);
            return services;
        }
        
        // Отображаем услуги в таблице и карточках
        function displayServices(services) {
            // Для десктопной таблицы
            const tbody = document.getElementById('services-list');
            if (tbody) {
                tbody.innerHTML = '';
                
                if (services.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <p>Услуги не найдены</p>
                                <button class="btn btn-sm btn-outline-primary" id="service-add-btn-empty">
                                    <i class="fas fa-plus"></i> Добавить первую услугу
                                </button>
                            </td>
                        </tr>
                    `;
                } else {
                    services.forEach((service, index) => {
                        const statusBadge = service.status === 'active' 
                            ? '<span class="badge bg-success">Активна</span>' 
                            : '<span class="badge bg-secondary">Неактивна</span>';
                        
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${service.id}</td>
                            <td>${service.name}</td>
                            <td>${service.company}</td>
                            <td>${service.category}</td>
                            <td>${service.price.toLocaleString('ru-RU')} ₽</td>
                            <td>${service.duration} мин</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1 edit-service-btn" data-id="${service.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-service-btn" data-id="${service.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            }
            
            // Для мобильных карточек
            const cardsContainer = document.getElementById('services-cards');
            if (cardsContainer) {
                cardsContainer.innerHTML = '';
                
                if (services.length === 0) {
                    cardsContainer.innerHTML = `
                        <div class="text-center py-4">
                            <p>Услуги не найдены</p>
                            <button class="btn btn-sm btn-outline-primary" id="service-add-btn-empty-mobile">
                                <i class="fas fa-plus"></i> Добавить первую услугу
                            </button>
                        </div>
                    `;
                } else {
                    const cardTemplate = document.getElementById('service-card-template').innerHTML;
                    
                    services.forEach(service => {
                        // Создаем HTML-карточку на основе шаблона
                        let cardHtml = cardTemplate;
                        // Заменяем переменные в шаблоне на значения
                        Object.keys(service).forEach(key => {
                            const regex = new RegExp('\\${' + key + '}', 'g');
                            cardHtml = cardHtml.replace(regex, service[key]);
                        });
                        
                        // Добавляем карточку на страницу
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = cardHtml;
                        cardsContainer.appendChild(tempDiv.firstElementChild);
                    });
                }
            }
            
            // Обработчики кнопок редактирования и удаления для обоих представлений
            document.querySelectorAll('.edit-service-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const serviceId = this.getAttribute('data-id');
                    openEditServiceModal(serviceId);
                });
            });
            
            document.querySelectorAll('.delete-service-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const serviceId = this.getAttribute('data-id');
                    openDeleteServiceModal(serviceId);
                });
            });
        }
        
        // Функция для открытия модального окна с формой добавления услуги
        function openAddServiceModal() {
            const serviceModal = document.getElementById('serviceModal');
            if (!serviceModal) {
                const template = document.getElementById('service-modal-template');
                if (template) {
                    const div = document.createElement('div');
                    div.innerHTML = template.innerHTML;
                    document.body.appendChild(div);
                    
                    // Загружаем компании для выпадающего списка
                    loadCompaniesForSelect();
                    
                    // Привязываем обработчик для сохранения
                    document.getElementById('save-service-btn').addEventListener('click', saveService);
                }
                
                const modal = new bootstrap.Modal(document.getElementById('serviceModal'));
                modal.show();
            } else {
                // Сбрасываем форму
                document.getElementById('serviceForm').reset();
                document.getElementById('service-id').value = '';
                document.getElementById('serviceModalLabel').textContent = 'Добавление услуги';
                
                // Показываем модальное окно
                const modal = bootstrap.Modal.getInstance(serviceModal) || new bootstrap.Modal(serviceModal);
                modal.show();
                
                // Загружаем компании для выпадающего списка
                loadCompaniesForSelect();
            }
        }
        
        // Функция для открытия модального окна с формой редактирования услуги
        function openEditServiceModal(serviceId) {
            // В реальности здесь был бы запрос к API для получения данных услуги
            // Для примера используем сохраненные данные
            const serviceData = currentServices.find(s => s.id == serviceId);
            
            if (!serviceData) {
                console.error('Услуга не найдена');
                return;
            }
            
            const serviceModal = document.getElementById('serviceModal');
            if (!serviceModal) {
                const template = document.getElementById('service-modal-template');
                if (template) {
                    const div = document.createElement('div');
                    div.innerHTML = template.innerHTML;
                    document.body.appendChild(div);
                    
                    // Загружаем компании для выпадающего списка
                    loadCompaniesForSelect();
                    
                    // Привязываем обработчик для сохранения
                    document.getElementById('save-service-btn').addEventListener('click', saveService);
                }
            }
            
            // Заполняем форму данными услуги
            document.getElementById('service-id').value = serviceData.id;
            document.getElementById('serviceModalLabel').textContent = 'Редактирование услуги';
            
            // Загружаем компании и затем выбираем нужную
            loadCompaniesForSelect(serviceData.company_id);
            
            // Заполняем остальные поля
            document.getElementById('service-category').value = serviceData.category_id;
            document.getElementById('service-name').value = serviceData.name;
            document.getElementById('service-price').value = serviceData.price;
            document.getElementById('service-duration').value = serviceData.duration;
            document.getElementById('service-status').value = serviceData.status;
            
            // Показываем модальное окно
            const modal = bootstrap.Modal.getInstance(serviceModal) || new bootstrap.Modal(serviceModal);
            modal.show();
        }
        
        // Функция для открытия модального окна подтверждения удаления
        function openDeleteServiceModal(serviceId) {
            // В реальности здесь был бы запрос к API для получения данных услуги
            // Для примера используем сохраненные данные
            const serviceData = currentServices.find(s => s.id == serviceId);
            
            if (!serviceData) {
                console.error('Услуга не найдена');
                return;
            }
            
            const deleteModal = document.getElementById('deleteServiceModal');
            if (!deleteModal) {
                const template = document.getElementById('service-delete-modal-template');
                if (template) {
                    const div = document.createElement('div');
                    div.innerHTML = template.innerHTML;
                    document.body.appendChild(div);
                    
                    // Привязываем обработчик для подтверждения удаления
                    document.getElementById('confirm-delete-service').addEventListener('click', function() {
                        deleteService(serviceId);
                        bootstrap.Modal.getInstance(document.getElementById('deleteServiceModal')).hide();
                    });
                }
            }
            
            // Заполняем данные
            document.getElementById('delete-service-name').textContent = serviceData.name;
            
            // Устанавливаем обработчик для кнопки удаления
            const confirmButton = document.getElementById('confirm-delete-service');
            confirmButton.onclick = function() {
                deleteService(serviceId);
                bootstrap.Modal.getInstance(document.getElementById('deleteServiceModal')).hide();
            };
            
            // Показываем модальное окно
            const modal = bootstrap.Modal.getInstance(deleteModal) || new bootstrap.Modal(deleteModal);
            modal.show();
        }
        
        // Функция для загрузки компаний в выпадающий список
        function loadCompaniesForSelect(selectedCompanyId) {
            // В реальности здесь был бы запрос к API
            const companies = [
                { id: 1, name: 'Салон красоты "Эстетика"' },
                { id: 2, name: 'Автосервис "Мастер"' },
                { id: 3, name: 'Спортзал "Атлетик"' },
                { id: 4, name: 'Медицинский центр "Здоровье"' }
            ];
            
            const select = document.getElementById('service-company');
            if (select) {
                // Очищаем текущие опции, оставляя только первую (placeholder)
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Добавляем компании как опции
                companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.id;
                    option.textContent = company.name;
                    select.appendChild(option);
                });
                
                // Выбираем компанию, если указана
                if (selectedCompanyId) {
                    select.value = selectedCompanyId;
                }
            }
        }
        
        // Функция для сохранения услуги
        function saveService() {
            const form = document.getElementById('serviceForm');
            
            // Валидация формы
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            
            // Собираем данные из формы
            const serviceId = document.getElementById('service-id').value;
            const serviceData = {
                id: serviceId ? parseInt(serviceId) : Math.floor(Math.random() * 1000) + 6, // Генерируем ID для новой услуги
                company_id: parseInt(document.getElementById('service-company').value),
                company: document.getElementById('service-company').options[document.getElementById('service-company').selectedIndex].text,
                category_id: parseInt(document.getElementById('service-category').value),
                category: document.getElementById('service-category').options[document.getElementById('service-category').selectedIndex].text,
                name: document.getElementById('service-name').value,
                price: parseFloat(document.getElementById('service-price').value),
                duration: parseInt(document.getElementById('service-duration').value),
                status: document.getElementById('service-status').value
                // В реальном приложении здесь были бы и другие поля
            };
            
            // В реальности здесь был бы запрос к API для сохранения данных
            console.log('Сохранение услуги:', serviceData);
            
            // Обновляем список услуг
            if (serviceId) {
                // Редактирование
                const index = currentServices.findIndex(s => s.id == serviceId);
                if (index !== -1) {
                    currentServices[index] = serviceData;
                }
            } else {
                // Добавление новой
                currentServices.push(serviceData);
            }
            
            // Обновляем таблицу
            displayServices(currentServices);
            
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('serviceModal'));
            modal.hide();
            
            // Сбрасываем форму
            form.reset();
            form.classList.remove('was-validated');
        }
        
        // Функция для удаления услуги
        function deleteService(serviceId) {
            // В реальности здесь был бы запрос к API для удаления
            console.log('Удаление услуги ID:', serviceId);
            
            // Удаляем услугу из массива
            const index = currentServices.findIndex(s => s.id == serviceId);
            if (index !== -1) {
                currentServices.splice(index, 1);
                
                // Обновляем таблицу
                displayServices(currentServices);
            }
        }
        
        // Обработчик для фильтра услуг
        document.addEventListener('input', function(e) {
            if (e.target && e.target.id === 'services-search') {
                const searchText = e.target.value.toLowerCase();
                const filteredServices = currentServices.filter(service => 
                    service.name.toLowerCase().includes(searchText) || 
                    service.company.toLowerCase().includes(searchText) ||
                    service.category.toLowerCase().includes(searchText)
                );
                displayServices(filteredServices);
            }
        });
        
        // Обработчик для изменения статуса фильтра
        document.addEventListener('change', function(e) {
            if (e.target && e.target.id === 'services-filter') {
                const filterValue = e.target.value;
                let filteredServices = currentServices;
                
                if (filterValue === 'active') {
                    filteredServices = currentServices.filter(service => service.status === 'active');
                } else if (filterValue === 'inactive') {
                    filteredServices = currentServices.filter(service => service.status === 'inactive');
                }
                
                displayServices(filteredServices);
            }
        });
        
        // Обработчик для кнопки добавления услуги
        document.addEventListener('click', function(e) {
            if (e.target.id === 'service-add-btn' || e.target.id === 'service-add-btn-empty' || 
                (e.target.parentElement && (e.target.parentElement.id === 'service-add-btn' || e.target.parentElement.id === 'service-add-btn-empty'))) {
                openAddServiceModal();
            }
        });
        
        // Загружаем начальные данные
        const currentServices = loadServices();
    });
</script>
{% endblock %}

{% block extra_js %}
<!-- Проверка доступности Chart.js -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof Chart === 'undefined') {
            console.error('Chart.js не загружен');
            // Добавляем сообщение об ошибке
            const eventsContainer = document.getElementById('events-list');
            if (eventsContainer) {
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';
                eventItem.innerHTML = `
                    <div class="event-icon danger">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="event-content">
                        <div class="event-message">Библиотека Chart.js не загружена. Графики недоступны.</div>
                        <div class="event-time">${new Date().toLocaleTimeString('ru-RU')}</div>
                    </div>
                `;
                eventsContainer.prepend(eventItem);
            }
        }
        
        // Обработчик для кнопки добавления услуги
        const addServiceBtn = document.getElementById('add-service-btn');
        const cancelServiceBtn = document.getElementById('cancel-service-btn');
        const quickAddServiceForm = document.querySelector('.quick-add-service-form');
        
        if (addServiceBtn) {
            addServiceBtn.addEventListener('click', function() {
                quickAddServiceForm.style.display = 'block';
                addServiceBtn.style.display = 'none';
                
                // Загружаем список компаний для выпадающего списка
                fetchCompanies();
            });
        }
        
        if (cancelServiceBtn) {
            cancelServiceBtn.addEventListener('click', function() {
                quickAddServiceForm.style.display = 'none';
                addServiceBtn.style.display = 'inline-block';
            });
        }
        
        // Обработчик формы быстрого добавления услуги
        const quickAddServiceFormEl = document.getElementById('quickAddServiceForm');
        if (quickAddServiceFormEl) {
            quickAddServiceFormEl.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Собираем данные услуги
                const serviceData = {
                    company_id: document.getElementById('serviceCompany').value,
                    name: document.getElementById('serviceName').value,
                    category_id: document.getElementById('serviceCategory').value,
                    price: document.getElementById('servicePrice').value,
                    duration: document.getElementById('serviceDuration').value,
                    description: document.getElementById('serviceDescription').value,
                    status: document.getElementById('serviceStatus').value
                };
                
                // Отправляем данные на сервер (в реальном приложении)
                console.log('Добавление услуги:', serviceData);
                
                // Симуляция успешного добавления
                alert('Услуга успешно добавлена!');
                
                // Скрываем форму после добавления
                quickAddServiceForm.style.display = 'none';
                addServiceBtn.style.display = 'inline-block';
                
                // Очищаем форму
                quickAddServiceFormEl.reset();
            });
        }
        
        // Функция для загрузки компаний
        function fetchCompanies() {
            // В реальном приложении здесь был бы запрос к API
            // Имитируем загрузку компаний
            const companies = [
                { id: 1, name: 'Салон красоты "Эстетика"' },
                { id: 2, name: 'Автосервис "Мастер"' },
                { id: 3, name: 'Спортзал "Атлетик"' },
                { id: 4, name: 'Медицинский центр "Здоровье"' }
            ];
            
            const selectElement = document.getElementById('serviceCompany');
            if (selectElement) {
                // Очищаем все опции кроме дефолтной
                while (selectElement.options.length > 1) {
                    selectElement.remove(1);
                }
                
                // Добавляем компании в селект
                companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.id;
                    option.textContent = company.name;
                    selectElement.appendChild(option);
                });
            }
        }
    });
</script>

<!-- JavaScript для обработки авторизации и регистрации -->
<script>
    // Функция для отображения статуса операции
    function showStatus(elementId, message, type) {
        const statusElement = document.getElementById(elementId);
        statusElement.textContent = message;
        statusElement.classList.remove('success', 'error');
        statusElement.classList.add(type);
        statusElement.style.display = 'block';
        
        // Автоматически скрываем сообщение через 5 секунд
        setTimeout(() => {
            statusElement.style.display = 'none';
        }, 5000);
    }
    
    // Обработчик формы входа
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        // Формируем данные для отправки в формате FormData
        const formData = new FormData();
        formData.append('username', email);
        formData.append('password', password);
        
        // Отправляем запрос на сервер
        fetch('/api/auth/token', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.access_token) {
                showStatus('login-status', 'Вход выполнен успешно!', 'success');
                
                // Обновляем профиль пользователя без перезагрузки страницы
                document.getElementById('user-profile-block').innerHTML = `
                    <div class="user-avatar">
                        <img src="${window.location.origin}/static/img/default-avatar.png" alt="Профиль">
                    </div>
                    <div class="user-info">
                        <div class="user-name">${data.user_email.split('@')[0]}</div>
                        <div class="user-email">${data.user_email}</div>
                        <div class="user-role">
                            <span class="badge bg-danger">${data.user_role || 'Пользователь'}</span>
                        </div>
                    </div>
                `;
                
                // Закрываем модальное окно через 1 секунду
                setTimeout(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
                    modal.hide();
                    
                    // Перезагружаем данные
                    if (typeof refreshData === 'function') {
                        refreshData();
                    }
                }, 1000);
            } else {
                showStatus('login-status', data.detail || 'Ошибка входа', 'error');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showStatus('login-status', 'Ошибка соединения с сервером', 'error');
        });
    });
    
    // Обработчик формы регистрации
    document.getElementById('registerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const passwordConfirm = document.getElementById('register-password-confirm').value;
        const firstName = document.getElementById('register-first-name').value;
        const lastName = document.getElementById('register-last-name').value;
        const phone = document.getElementById('register-phone').value;
        
        // Проверяем совпадение паролей
        if (password !== passwordConfirm) {
            showStatus('register-status', 'Пароли не совпадают', 'error');
            return;
        }
        
        // Формируем данные для отправки
        const userData = {
            email: email,
            password: password,
            password_confirm: passwordConfirm,
            role: "client"
        };
        
        // Добавляем опциональные поля, если они заполнены
        if (firstName) userData.first_name = firstName;
        if (lastName) userData.last_name = lastName;
        if (phone) userData.phone = phone;
        
        // Отправляем запрос на сервер
        fetch('/api/auth/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                showStatus('register-status', 'Регистрация успешно завершена!', 'success');
                
                // Очищаем форму
                document.getElementById('registerForm').reset();
                
                // Переключаемся на вкладку входа через 2 секунды
                setTimeout(() => {
                    const loginTab = document.getElementById('login-tab');
                    bootstrap.Tab.getInstance(loginTab).show();
                    
                    // Предзаполняем поле email на форме входа
                    document.getElementById('login-email').value = email;
                }, 2000);
            } else {
                showStatus('register-status', data.detail || 'Ошибка регистрации', 'error');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showStatus('register-status', 'Ошибка соединения с сервером', 'error');
        });
    });
</script>

<script src="{{ url_for('static', path='js/situation_center.js') }}"></script>

<!-- JavaScript для мобильной навигации -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Обработчик для мобильной навигации
        const mobileNavBtns = document.querySelectorAll('.mobile-nav-btn');
        if (mobileNavBtns.length > 0) {
            mobileNavBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    
                    // Удаляем активный класс со всех кнопок
                    mobileNavBtns.forEach(b => b.classList.remove('active'));
                    
                    // Добавляем активный класс на нажатую кнопку
                    this.classList.add('active');
                    
                    // Находим соответствующий элемент в основной навигации и имитируем клик
                    const mainNavItem = document.querySelector(`.nav-item[data-section="${section}"]`);
                    if (mainNavItem) {
                        mainNavItem.click();
                    } else if (section === 'profile') {
                        // Обработка специальных случаев, например профиль
                        document.querySelector('.nav-item[data-section="profile"]').click();
                    }
                    
                    // Прокручиваем страницу вверх после смены раздела
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            });
        }
        
        // Регистрируем обработчик для изменения размера окна
        window.addEventListener('resize', handleResize);
        
        // Вызываем сразу для установки начального состояния
        handleResize();
        
        function handleResize() {
            if (window.innerWidth < 992) {
                // Для мобильных устройств убираем overflow: hidden с body
                document.body.style.overflow = 'auto';
                
                // Добавляем отступ внизу контейнера для мобильной навигации
                const situationCenter = document.getElementById('situation-center');
                if (situationCenter) {
                    situationCenter.style.paddingBottom = '70px';
                }
            } else {
                // Для десктопа восстанавливаем overflow: hidden
                document.body.style.overflow = 'hidden';
                
                // Убираем отступ для мобильной навигации
                const situationCenter = document.getElementById('situation-center');
                if (situationCenter) {
                    situationCenter.style.paddingBottom = '0';
                }
            }
        }
    });
</script>
{% endblock %} 